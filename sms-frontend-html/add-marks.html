<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Marks</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .mark-row {
      margin-bottom: 10px;
    }
    .status-message {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <h2>üßÆ Enter Marks for Scheduled Test</h2>

    <label for="classSelect">Class:</label>
    <select id="classSelect">
      <option value="">-- Select Class --</option>
    </select>

    <label for="testSelect">Test:</label>
    <select id="testSelect">
      <option value="">-- Select Test --</option>
    </select>

    <div id="marksForm" style="margin-top: 20px;"></div>

    <script>
      async function loadClasses() {
        try {
          const res = await fetch("http://127.0.0.1:5000/api/classes");
          const result = await res.json();

          const select = document.getElementById("classSelect");
          select.innerHTML = '<option value="">-- Select Class --</option>';

          result.classes.forEach(cls => {
            const option = document.createElement("option");
            option.value = cls;
            option.textContent = cls;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Failed to load classes:", err);
          alert("‚ö†Ô∏è Could not load class list.");
        }
      }

      document.getElementById("classSelect").addEventListener("change", async (e) => {
        const className = e.target.value;
        if (!className) return;

        const res = await fetch(`http://127.0.0.1:5000/api/scheduled-tests?class=${encodeURIComponent(className)}`);
        const result = await res.json();

        const testSelect = document.getElementById("testSelect");
        testSelect.innerHTML = "";

        if (!result.success || result.tests.length === 0) {
          testSelect.innerHTML = "<option>No tests found</option>";
          return;
        }

        testSelect.innerHTML = '<option value="">-- Select Test --</option>';
        result.tests.forEach(t => {
          const option = document.createElement("option");
          option.value = `${t.subject}|${t.date}|${t.max_marks}`;
          option.textContent = `${t.subject} on ${t.date} (Max: ${t.max_marks})`;
          testSelect.appendChild(option);
        });

        testSelect.onchange = () => loadStudents(className);
      });
      async function loadStudents(classNameRaw) {
        const className = classNameRaw.trim().toLowerCase(); // ‚úÖ Normalize class name
        const testValue = document.getElementById("testSelect").value;
        if (!testValue) return;

        const [rawSubject, rawDate, rawMax] = testValue.split("|");
        const subject = rawSubject.trim();
        const date = rawDate.trim();
        const max_marks = parseInt(rawMax.trim());

        try {
          const res = await fetch(`http://127.0.0.1:5000/api/class-students?class=${encodeURIComponent(className)}&subject=${encodeURIComponent(subject)}&date=${encodeURIComponent(date)}`);
          const result = await res.json();

          const container = document.getElementById("marksForm");
          container.innerHTML = `<h3>Enter marks for ${subject} (${date})</h3>`;

          // ‚úÖ Proper check for student array
          if (!Array.isArray(result.students) || result.students.length === 0) {
            container.innerHTML += `<p style="color: red;">‚ö†Ô∏è No students found for ${classNameRaw}. Please check your student records.</p>`;
            return;
          }

          const students = result.students;
          const pendingStudents = students.filter(s => !s.submitted);

          if (pendingStudents.length === 0) {
            container.innerHTML += `<p style="color: green;">‚úÖ All marks for this test have been submitted.</p>`;
            return;
          }

          const form = document.createElement("form");
          form.id = "marksEntryForm";
          form.method = "POST";

          pendingStudents.forEach(s => {
            const studentId = s.student_id || s.id;
            const row = document.createElement("div");
            row.classList.add("mark-row");

            row.innerHTML = `
              <label>${s.name} (${studentId}):</label>
              <input type="number" name="${studentId}" data-name="${s.name}" min="0" max="${typeof s.max_marks === 'number' ? s.max_marks : max_marks}" required />
            `;

            form.appendChild(row);
          });

          const submitBtn = document.createElement("button");
          submitBtn.textContent = "‚úÖ Submit Marks";
          submitBtn.type = "submit";
          form.appendChild(submitBtn);

          const statusDiv = document.createElement("div");
          statusDiv.id = "statusMessage";
          statusDiv.className = "status-message";
          form.appendChild(statusDiv);

          form.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const marks_data = [];

            for (let [id, value] of formData.entries()) {
              if (!id || value === "") continue;

              const input = form.querySelector(`input[name="${id}"]`);
              const name = input.dataset.name || "Unknown";

              marks_data.push({
                student_id: id,
                name: name,
                marks: parseInt(value),
                class: classNameRaw.trim(), // preserve original casing
                subject: subject,
                date: date,
                submitted: true
              });
            }

            if (marks_data.length === 0) {
              statusDiv.textContent = "‚ùå Please enter at least one mark.";
              statusDiv.style.color = "red";
              return;
            }

            const res = await fetch("http://127.0.0.1:5000/api/save-marks", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ subject, date, marks_data })
            });

            const result = await res.json();
            if (result.success) {
              statusDiv.innerHTML = `‚úÖ Marks saved!<br>Added: ${result.added}<br>Skipped: ${result.skipped}`;
              statusDiv.style.color = "green";
              form.reset();
              await loadStudents(classNameRaw); // üîÑ Refresh with original casing
            } else {
              statusDiv.textContent = result.message;
              statusDiv.style.color = "red";
            }
          };

          container.appendChild(form);
        } catch (err) {
          console.error("‚ùå Failed to load students:", err);
          alert("Could not load student data.");
        }
      }
      

      window.onload = loadClasses;
    </script>
  </div>
</body>
</html>