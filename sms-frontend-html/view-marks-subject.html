<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Marks by Subject</title>
  <link rel="stylesheet" href="style.css">
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    .analytics-box {
      margin-top: 20px;
      padding: 10px;
      background-color: #eef;
      border: 1px solid #99c;
    }
    .top-scorer-row {
      background-color: #dfffdc;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <h2>üìò View Marks by Subject</h2>

    <label for="classSelect">Class:</label>
    <select id="classSelect">
      <option value="">-- Select Class --</option>
    </select>

    <label for="testSelect">Test:</label>
    <select id="testSelect">
      <option value="">-- Select Test --</option>
    </select>

    <button onclick="loadSubjectMarks()">üîç View Marks</button>

    <div id="marksDisplay" style="margin-top: 20px;"></div>

    <script>
      async function loadClasses() {
        try {
          const res = await fetch("http://127.0.0.1:5000/api/classes");
          const result = await res.json();

          const select = document.getElementById("classSelect");
          select.innerHTML = '<option value="">-- Select Class --</option>';

          result.classes.forEach(cls => {
            const option = document.createElement("option");
            option.value = cls;
            option.textContent = cls;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Failed to load classes:", err);
          alert("‚ö†Ô∏è Could not load class list.");
        }
      }

      async function loadSubjectMarks() {
        const className = document.getElementById("classSelect").value.trim();
        const testValue = document.getElementById("testSelect").value;
        if (!testValue) {
          alert("Please select a test.");
          return;
        }

        const [subject, date, max_marks] = testValue.split("|");

        if (!className || !subject || !date) {
          alert("Please fill all fields.");
          return;
        }

        try {
          const res = await fetch(`http://127.0.0.1:5000/api/subject-marks?class=${encodeURIComponent(className)}&subject=${encodeURIComponent(subject)}&date=${encodeURIComponent(date)}`);
          const result = await res.json();

          const container = document.getElementById("marksDisplay");
          container.innerHTML = "";

          if (!result.success || !Array.isArray(result.marks) || result.marks.length === 0) {
            container.innerHTML = "<p>‚ö†Ô∏è No marks found for this test.</p>";
            return;
          }

          const topScorerId = result.analytics?.top_scorer?.student_id;

          const table = document.createElement("table");
          table.innerHTML = `
            <tr>
              <th>Student ID</th>
              <th>Name</th>
              <th>Marks</th>
              <th>Max Marks</th>
            </tr>
          `;

          result.marks.forEach(m => {
            const row = document.createElement("tr");
            if (m.student_id === topScorerId) {
              row.classList.add("top-scorer-row");
            }
            row.innerHTML = `
              <td>${m.student_id}</td>
              <td>${m.name}</td>
              <td>${m.marks}</td>
              <td>${m.max_marks}</td>
            `;
            table.appendChild(row);
          });

          const analytics = result.analytics || {};
          const summary = document.createElement("div");
          summary.className = "analytics-box";
          summary.innerHTML = `
            <h3>üìä Class Analytics</h3>
            <p>Average Marks: ${analytics.average ?? "N/A"}</p>
            <p>Highest Marks: ${analytics.highest ?? "N/A"}${analytics.top_scorer?.name ? ` (${analytics.top_scorer.name})` : ""}</p>
            <p>Lowest Marks: ${analytics.lowest ?? "N/A"}</p>
          `;

          container.appendChild(table);
          container.appendChild(summary);
        } catch (err) {
          console.error("Error loading marks:", err);
          alert("‚ùå Failed to fetch marks.");
        }
      }

      window.onload = () => {
        loadClasses();

        document.getElementById("classSelect").addEventListener("change", async (e) => {
          const className = e.target.value;
          if (!className) return;

          const res = await fetch(`http://127.0.0.1:5000/api/scheduled-tests?class=${encodeURIComponent(className)}`);
          const result = await res.json();

          const testSelect = document.getElementById("testSelect");
          testSelect.innerHTML = "";

          if (!result.success || result.tests.length === 0) {
            testSelect.innerHTML = "<option>No tests found</option>";
            return;
          }

          testSelect.innerHTML = '<option value="">-- Select Test --</option>';
          result.tests.forEach(t => {
            const option = document.createElement("option");
            option.value = `${t.subject}|${t.date}|${t.max_marks}`;
            option.textContent = `${t.subject} on ${t.date} (Max: ${t.max_marks})`;
            testSelect.appendChild(option);
          });
        });
      };
    </script>
  </div>
</body>
</html>